{"version":3,"file":"ioc.js","sources":["../src/ioc/container.ts","../src/ioc/inject.ts"],"sourcesContent":["interface IConfig<T> {\n    object?: INewAble<T>;\n    factory?: Factory<T>;\n    value?: Value<T>;\n    cache?: T;\n    singleton: boolean;\n}\n\ninterface INewAble<T> {\n    new (...args: any[]): T;\n}\n\ntype Registry = Map<symbol, IConfig<any>>;\n\ntype Factory<T> = () => T;\ntype Value<T> = T;\n\nclass Options<T> {\n    constructor(private _target: IConfig<T>) {}\n\n    inSingletonScope() {\n        this._target.singleton = true;\n    }\n}\n\nclass Bind<T> {\n    constructor(private _target: IConfig<T>) {}\n\n    to(object: INewAble<T>): Options<T> {\n        this._target.object = object;\n        return new Options<T>(this._target);\n    }\n\n    toFactory(factory: Factory<T>): Options<T> {\n        this._target.factory = factory;\n        return new Options<T>(this._target);\n    }\n\n    toValue(value: Value<T>): void {\n        if (typeof value === \"undefined\") {\n            throw \"cannot bind a value of type undefined\";\n        }\n        this._target.value = value;\n    }\n}\n\nexport class Container {\n    private _registry: Registry = new Map<symbol, IConfig<any>>();\n    private _snapshots: Registry[] = [];\n\n    bind<T = never>(type: symbol): Bind<T> {\n        return new Bind<T>(this._add<T>(type));\n    }\n\n    rebind<T = never>(type: symbol): Bind<T> {\n        return this.remove(type).bind<T>(type);\n    }\n\n    remove(type: symbol): Container {\n        if (this._registry.get(type) === undefined) {\n            throw `${type.toString()} was never bound`;\n        }\n\n        this._registry.delete(type);\n\n        return this;\n    }\n\n    get<T = never>(type: symbol): T {\n        const regItem = this._registry.get(type);\n\n        if (regItem === undefined) {\n            throw `nothing bound to ${type.toString()}`;\n        }\n\n        const {object, factory, value, cache, singleton} = regItem;\n\n        const cacheItem = (creator: () => T): T => {\n            if (singleton && typeof cache !== \"undefined\") return cache;\n            if (!singleton) return creator();\n            regItem.cache = creator();\n            return regItem.cache;\n        };\n\n        if (typeof value !== \"undefined\") return value;\n        if (typeof object !== \"undefined\") return cacheItem(() => new object());\n        if (typeof factory !== \"undefined\") return cacheItem(() => factory());\n\n        throw `nothing is bound to ${type.toString()}`;\n    }\n\n    snapshot(): Container {\n        this._snapshots.push(new Map(this._registry));\n        return this;\n    }\n\n    restore(): Container {\n        this._registry = this._snapshots.pop() || this._registry;\n        return this;\n    }\n\n    private _add<T>(type: symbol): IConfig<T> {\n        if (this._registry.get(type) !== undefined) {\n            throw `object can only bound once: ${type.toString()}`;\n        }\n\n        const conf = {singleton: false};\n        this._registry.set(type, conf);\n\n        return conf;\n    }\n}\n","import {Container} from \"./container\";\n\nexport const NOCACHE = Symbol(\"NOCACHE\");\n\nfunction define(target: object, property: string, container: Container, type: symbol, args: symbol[]) {\n    Object.defineProperty(target, property, {\n        get: function() {\n            const value = container.get<any>(type);\n            if (args.indexOf(NOCACHE) === -1) {\n                Object.defineProperty(this, property, {\n                    value,\n                    enumerable: true,\n                });\n            }\n            return value;\n        },\n        configurable: true,\n        enumerable: true,\n    });\n}\n\nfunction inject(type: symbol, container: Container, args: symbol[]) {\n    return (target: object, property: string): void => {\n        define(target, property, container, type, args);\n    };\n}\n\nexport function createDecorator(container: Container) {\n    return (type: symbol, ...args: symbol[]) => {\n        return inject(type, container, args);\n    };\n}\n\nexport function createWire(container: Container) {\n    return <T extends object>(target: T, property: keyof T & string, type: symbol, ...args: symbol[]) => {\n        define(target, property, container, type, args);\n    };\n}\n\nexport function createResolve(container: Container) {\n    return <T = never>(type: symbol, ...args: symbol[]) => {\n        let value: T;\n        return (): T => {\n            if (args.indexOf(NOCACHE) !== -1 || value === undefined) {\n                value = container.get<T>(type);\n            }\n            return value;\n        };\n    };\n}\n"],"names":["Options","constructor","_target","inSingletonScope","singleton","Bind","to","object","this","toFactory","factory","toValue","value","Container","Map","bind","type","_add","rebind","remove","undefined","_registry","get","toString","delete","regItem","cacheItem","creator","cache","snapshot","_snapshots","push","restore","pop","conf","set","NOCACHE","Symbol","define","target","property","container","args","Object","defineProperty","indexOf","enumerable","configurable","inject"],"mappings":"AAiBA,IAAMA,EACFC,SAAoBC,UAAAA,GAEpBC,YAAAA,iCACSD,EAAQE,WAAY,GAIjC,IAAMC,EACFJ,SAAoBC,UAAAA,GAEpBI,YAAAA,YAAGC,eACML,EAAQK,OAASA,EACf,IAAIP,EAAWQ,KAAKN,IAG/BO,YAAAA,mBAAUC,eACDR,EAAQQ,QAAUA,EAChB,IAAIV,EAAWQ,KAAKN,IAG/BS,YAAAA,iBAAQC,WACiB,IAAVA,OACD,6CAELV,EAAQU,MAAQA,OAIhBC,EAAbZ,kBACkC,IAAIa,WACD,IAEjCC,YAAAA,cAAgBC,UACL,IAAIX,EAAQG,KAAKS,EAAQD,KAGpCE,YAAAA,gBAAkBF,UACPR,KAAKW,OAAOH,GAAMD,KAAQC,IAGrCG,YAAAA,gBAAOH,WAC8BI,IAA7BZ,KAAKa,EAAUC,IAAIN,SACVA,EAAKO,0CAGbF,EAAUG,OAAOR,GAEfR,MAGXc,YAAAA,aAAeN,OACLS,EAAUjB,KAAKa,EAAUC,IAAIN,WAEnBI,IAAZK,2BAC0BT,EAAKO,wEAK7BG,WAAaC,UACXvB,QAA8B,IAAVwB,EAA8BA,EACjDxB,GACLqB,EAAQG,MAAQD,IACTF,EAAQG,OAFQD,aAKN,IAAVf,EAAuB,OAAOA,UACnB,IAAXL,EAAwB,OAAOmB,oBAAgB,IAAInB,YACvC,IAAZG,EAAyB,OAAOgB,oBAAgBhB,kCAE9BM,EAAKO,YAGtCM,YAAAA,gCACSC,EAAWC,KAAK,IAAIjB,IAAIN,KAAKa,IAC3Bb,MAGXwB,YAAAA,+BACSX,EAAYb,KAAKsB,EAAWG,OAASzB,KAAKa,EACxCb,MAGHS,YAAAA,WAAQD,WACqBI,IAA7BZ,KAAKa,EAAUC,IAAIN,uCACkBA,EAAKO,eAGxCW,EAAO,YAAY,eACpBb,EAAUc,IAAInB,EAAMkB,GAElBA,OC3GFE,EAAUC,OAAO,WAE9B,SAASC,EAAOC,EAAgBC,EAAkBC,EAAsBzB,EAAc0B,GAClFC,OAAOC,eAAeL,EAAQC,EAAU,CACpClB,IAAK,eACKV,EAAQ6B,EAAUnB,IAASN,UACF,IAA3B0B,EAAKG,QAAQT,IACbO,OAAOC,eAAepC,KAAMgC,EAAU,OAClC5B,EACAkC,YAAY,IAGblC,GAEXmC,cAAc,EACdD,YAAY,yDAUYL,mBACpBzB,wEAPZ,SAAgBA,EAAcyB,EAAsBC,mBACxCH,EAAgBC,GACpBF,EAAOC,EAAQC,EAAUC,EAAWzB,EAAM0B,IAMnCM,CAAOhC,EAAMyB,EAAWC,iCAIZD,mBACGF,EAAWC,EAA4BxB,iEAC7DsB,EAAOC,EAAQC,EAAUC,EAAWzB,EAAM0B,oCAIpBD,mBACPzB,WACXJ,iFAE+B,IAA3B8B,EAAKG,QAAQT,SAA6BhB,IAAVR,IAChCA,EAAQ6B,EAAUnB,IAAON,IAEtBJ"}